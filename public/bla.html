<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Video review</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">


	<link href="//vjs.zencdn.net/6.4.0/video-js.min.css" rel="stylesheet">
	<link href="/css/videojs.record.min.css" rel="stylesheet">


	<style>
	/* change player background color */
	#myVideo {
	  background-color: #9ab87a;
	}
	</style>
</head>
<body>

	<div style="margin: 0 auto; max-width: 720px;" id="wrapper">
		<video id="myVideo" class="video-js vjs-default-skin"></video>
		<a href="javascript:;" id="init">Click here to START your camera</a>
		<a href="javascript:;" id="start" style="display: none;">Click here to START recording</a>
		<a href="javascript:;" id="stop" style="display: none;">Click here to STOP recording</a>
	</div>
	<div style="margin: 0 auto; max-width: 720px;" id="log">
		Log:<br/>
	</div>


	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script src="//vjs.zencdn.net/6.4.0/video.min.js"></script>
	<script src="//cdn.WebRTC-Experiment.com/RecordRTC.js"></script>
	<script src="//webrtc.github.io/adapter/adapter-latest.js"></script>
	<script src="/js/videojs.record.min.js"></script>


	<script>
    
		var player = videojs("myVideo", {
		    controls: true,
		    //width: 720,
		    //height: 405,
		    fluid: true,
		    plugins: {
		        record: {
		            audio: true,
		            video: true,
		            maxLength: 600,
		            debug: true
		        }
		    }
		}, function(){
		    // print version information at startup
		    videojs.log('Using video.js', videojs.VERSION,
		        'with videojs-record', videojs.getPluginVersion('record'),
		        'and recordrtc', RecordRTC.version);
		});

		$('#init').click( function() {
			var hm = player.record().getDevice();
		} );
		$('#start').click( function() {
			player.record().start();
			$('#start').hide();
			$('#stop').show();
		} );
		$('#stop').click( function() {
			player.record().stop();
			$('#wrapper').hide();

		});

		// error handling
		player.on('deviceError', function() {
			$('#log').append('Device error: ');
			$('#log').append(player.deviceErrorCode.name);
			$('#log').append('<br/>');		    	
		    console.log('device error:', player.deviceErrorCode);
		    if(player.deviceErrorCode.name && player.deviceErrorCode.name=="NotAllowedError") {
				$('#log').append('Please allow us to use your camera and mic');
				$('#log').append('<br/>');		    	
		    }
		});

		player.on('error', function(error) {
		    console.log('error:', error);
		    $('#log').append('error: ');
		    $('#log').append(error);
			$('#log').append('<br/>');		    	
		    
		});

		// user clicked the record button and started recording
		player.on('startRecord', function() {
		    console.log('started recording!');
		});


		// user clicked the record button and started recording
		player.on('deviceReady', function() {
			$('#init').hide();
			$('#start').show();
		    console.log('deviceReady!');
		});

		// user completed recording and stream is available
		player.on('finishRecord', function() {
		    // the blob object contains the recorded data that
		    // can be downloaded by the user, stored on server etc.
		    console.log('finished recording: ', player.recordedData, player.recordedData.video);

		    var fd = new FormData();
			fd.append('qqfile', player.recordedData.video ? player.recordedData.video : player.recordedData);
			$.ajax({
			    xhr: function() {
					var xhr = new window.XMLHttpRequest();
					xhr.upload.addEventListener("progress", function(evt) {
					    if (evt.lengthComputable) {
					        var percentComplete = evt.loaded / evt.total;
					        //Do something with upload progress here
							$('#log').append('Progress ' + percentComplete + '%');
							$('#log').append('<br/>');
					    }
						}, false);

					xhr.addEventListener("progress", function(evt) {
					   if (evt.lengthComputable) {
							var percentComplete = evt.loaded / evt.total;
							//Do something with download progress
							$('#log').append('Progress ' + percentComplete + '%');
							$('#log').append('<br/>');
					   }
					}, false);

					return xhr;
			    },
			    type: 'POST',
			    url: '/test',
			    data: fd,
			    processData: false,
			    contentType: false,
			    dataType: 'json'
			}).done(function(responseJSON) {
				if (responseJSON.url) {
					$('#log').append('Success: <a href="'+responseJSON.url+'" target="_blank">' + responseJSON.url + '</a>');
					$('#log').append('<br/>');
				} else {
					$('#log').append('FAIL!');
					$('#log').append('<br/>');
				}
			});
		});
	</script>

</body>
</html>